# Knooppunt Policy Enforcement Point Configuration

# Import JavaScript module for authorization
js_import authorize from /etc/nginx/js/authorize.js;

# Upstream for FHIR backend
upstream fhir_backend {
    server ${FHIR_BACKEND_HOST}:${FHIR_BACKEND_PORT};
    keepalive 32;
}

# Upstream for Nuts node (token introspection, DPoP validation)
upstream nuts_node {
    server ${NUTS_NODE_HOST}:${NUTS_NODE_INTERNAL_PORT};
    keepalive 32;
}

# Upstream for Knooppunt PDP
upstream knooppunt_pdp {
    server ${KNOOPPUNT_PDP_HOST}:${KNOOPPUNT_PDP_PORT};
    keepalive 32;
}

server {
    listen ${NGINX_PORT} default_server;
    server_name _;

    # Rate limiting
    limit_req zone=pep_limit burst=20 nodelay;
    limit_req_status 429;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header Cache-Control "no-store" always;

    # Custom log format with authorization details
    access_log /var/log/nginx/pep-access.log authz;
    # Log errors to stderr for container visibility, plus file for production
    error_log /dev/stderr warn;
    error_log /var/log/nginx/pep-error.log warn;

    # Health check endpoint
    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "healthy\n";
    }

    # FHIR API routes - protected by authorization
    # FHIR_BASE_PATH: incoming path clients use (default: /fhir)
    # FHIR_UPSTREAM_PATH: path on backend FHIR server (default: same as FHIR_BASE_PATH)
    location ${FHIR_BASE_PATH}/ {
        # Call authorization subrequest before proxying
        auth_request /_authorize;

        # Error handling for authorization failures
        error_page 401 = @error401;
        error_page 403 = @error403;
        error_page 500 502 503 504 = @error5xx;

        # Forward to FHIR backend if authorized
        rewrite ^${FHIR_BASE_PATH}/(.*)$ ${FHIR_UPSTREAM_PATH}/$1 break;
        proxy_pass http://fhir_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Remove sensitive headers before forwarding
        proxy_set_header Authorization "";

        # Timeouts for FHIR operations
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Internal authorization endpoint
    location = /_authorize {
        internal;
        js_content authorize.checkAuthorization;
    }

    # Internal: Token introspection via Nuts node (RFC 7662)
    location = /_introspect {
        internal;
        proxy_pass http://nuts_node/internal/auth/v2/accesstoken/introspect;
        proxy_method POST;
        proxy_set_header Content-Type "application/x-www-form-urlencoded";
        proxy_pass_request_body on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # Internal: DPoP validation via Nuts node (RFC 9449)
    location = /_dpop_validate {
        internal;
        proxy_pass http://nuts_node/internal/auth/v2/dpop/validate;
        proxy_method POST;
        proxy_set_header Content-Type "application/json";
        proxy_pass_request_body on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # Internal: PDP authorization check
    location = /_pdp {
        internal;
        proxy_pass http://knooppunt_pdp/pdp;
        proxy_method POST;
        proxy_set_header Content-Type "application/json";
        proxy_pass_request_body on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # Error pages
    # RFC 6750 Section 3 requires WWW-Authenticate header on 401 responses
    # RFC 9449 Section 7.2: Advertise both DPoP and Bearer support
    location @error401 {
        add_header WWW-Authenticate 'DPoP realm="knooppunt", error="invalid_token", Bearer realm="knooppunt", error="invalid_token"' always;
        add_header Content-Type application/json always;
        return 401 '{"error": "Unauthorized", "message": "Missing or invalid authentication"}';
    }

    location @error403 {
        add_header Content-Type application/json;
        return 403 '{"error": "Forbidden", "message": "Access denied by authorization policy"}';
    }

    location @error5xx {
        add_header Content-Type application/json;
        return 500 '{"error": "Internal Server Error", "message": "Authorization service unavailable"}';
    }
}
