# Knooppunt Policy Enforcement Point Configuration

# Import JavaScript module for authorization
js_import authorize from /etc/nginx/js/authorize.js;

# Upstream for FHIR backend
upstream fhir_backend {
    server ${FHIR_BACKEND_HOST}:${FHIR_BACKEND_PORT};
    keepalive 32;
}

# Note: Knooppunt PDP and Nuts node calls are made via ngx.fetch in authorize.js
# rather than nginx upstreams, because njs subrequests don't work well with
# POST bodies through proxy_pass.

server {
    listen ${NGINX_PORT} default_server;
    server_name _;

    # DNS resolver for ngx.fetch (required for HTTP requests in njs)
    # Configurable via DNS_RESOLVER env var. Common values:
    # - 127.0.0.11: Docker embedded DNS (Linux containers, CI)
    # - 192.168.65.7: Docker Desktop DNS (macOS)
    # - 8.8.8.8: Google DNS (fallback)
    resolver ${DNS_RESOLVER} valid=30s ipv6=off;
    resolver_timeout 5s;

    # Rate limiting
    limit_req zone=pep_limit burst=20 nodelay;
    limit_req_status 429;

    # Custom log format with authorization details
    access_log /var/log/nginx/pep-access.log authz;
    # Log errors to stderr for container visibility, plus file for production
    error_log /dev/stderr warn;
    error_log /var/log/nginx/pep-error.log warn;

    # Health check endpoint
    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "healthy\n";
    }

    # FHIR API routes - protected by authorization
    location /fhir/ {
        # Call authorization subrequest before proxying
        auth_request /_authorize;

        # Error handling for authorization failures
        error_page 401 = @error401;
        error_page 403 = @error403;
        error_page 500 502 503 504 = @error5xx;

        # Forward to FHIR backend if authorized
        # Rewrite /fhir/Patient/123 to ${FHIR_BASE_PATH}/Patient/123
        rewrite ^/fhir/(.*)$ ${FHIR_BASE_PATH}/$1 break;
        proxy_pass http://fhir_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Remove sensitive headers before forwarding
        proxy_set_header Authorization "";

        # Timeouts for FHIR operations
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Internal authorization endpoint
    # authorize.js handles introspection, DPoP validation, and PDP calls via ngx.fetch
    location = /_authorize {
        internal;
        js_content authorize.checkAuthorization;
    }

    # Error pages
    # RFC 6750 Section 3 requires WWW-Authenticate header on 401 responses
    # RFC 9449 Section 7.2: Advertise both DPoP and Bearer support
    location @error401 {
        add_header WWW-Authenticate 'DPoP realm="knooppunt", error="invalid_token"' always;
        add_header WWW-Authenticate 'Bearer realm="knooppunt", error="invalid_token"' always;
        add_header Content-Type application/json always;
        return 401 '{"error": "Unauthorized", "message": "Missing or invalid authentication"}';
    }

    location @error403 {
        add_header Content-Type application/json;
        return 403 '{"error": "Forbidden", "message": "Access denied by authorization policy"}';
    }

    location @error5xx {
        add_header Content-Type application/json;
        return 500 '{"error": "Internal Server Error", "message": "Authorization service unavailable"}';
    }
}
