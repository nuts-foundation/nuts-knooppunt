# Configuration

The Knooppunt application supports configuration through YAML files and environment variables.

## Sources

Configuration is loaded in the following order (later sources override earlier ones):

1. Default values
2. YAML configuration files, loaded from:
    - `config/knooppunt.yml`: Knooppunt-specific configuration ([example](../config/knooppunt.yml))
    - `config/nuts.yml`: Nuts-specific configuration,
      see [Nuts documentation](https://nuts-node.readthedocs.io/en/stable/pages/deployment/configuration.html) ([example](../config/nuts.yml))
3. Environment variables with `KNPT_` prefix

## Configuration Options

Environment variables use the prefix `KNPT_` followed by the configuration path in uppercase with underscores (if you enable NUTS node as embedded service within your knoppunt, those variables are prefixed with `NUTS_`):

| Environment Variable                      | YAML Path                            | Description                                                                                                                                                                                                                                                                               |
|-------------------------------------------|--------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **General**                               |                                      |                                                                                                                                                                                                                                                                                           |
| `KNPT_STRICTMODE`                         | `strictmode`                         | Enables secure operation mode. Disabling it allows connection to plain HTTP server, and [OIDC Provider dev mode](https://zitadel.com/docs/guides/manage/console/applications#development-mode). It also sets the Nuts node's strict mode configuration parameter.<br/>Defaults to `true`. |
| **HTTP**                                  |                                      |                                                                                                                                                                                                                                                                                           |
| `KNPT_HTTP_PUBLIC_ADDRESS`                | `http.public.address`                | TCP address for the public HTTP interface.<br/>Defaults to `:8080`.                                                                                                                                                                                                                       |
| `KNPT_HTTP_PUBLIC_URL`                    | `http.public.url`                    | (Optional) Public base URL. If not specified, defaults to `http://<hostname>:<port>`.                                                                                                                                                                                                     |
| `KNPT_HTTP_INTERNAL_ADDRESS`              | `http.internal.address`              | TCP address for the internal HTTP interface.<br/>Defaults to `:8081`.                                                                                                                                                                                                                     |
| `KNPT_HTTP_INTERNAL_URL`                  | `http.internal.url`                  | (Optional) Internal base URL. If not specified, defaults to `http://<hostname>:<port>`.                                                                                                                                                                                                   |
| **Authentication / Nuts**                 |                                      |                                                                                                                                                                                                                                                                                           |
| `KNPT_NUTS_ENABLED`                       | `nuts.enabled`                       | Enable embedded Nuts node.<br/>Defaults to `false`.                                                                                                                                                                                                                                       |
| `NUTS_*`                                  | config/nuts.yml file                 | Nuts specific configuration variables are either prefixed with NUTS_ or are present in config/nuts.yml file                                                                                                                                                                               |
| **Addressing / mCSD**                     |                                      |                                                                                                                                                                                                                                                                                           |
| `KNPT_MCSDADMIN_FHIRBASEURL`              | `mcsdadmin.fhirbaseurl`              | (Optional) FHIR base URL of the local mCSD Administration Directory, if managed through the mCSD Web Application.                                                                                                                                                                         |
| `KNPT_MCSD_QUERY_FHIRBASEURL`             | `mcsd.query.fhirbaseurl`             | FHIR base URL of the local mCSD Query Directory to synchronize to.                                                                                                                                                                                                                        |
| `KNPT_MCSD_ADMIN_<KEY>_FHIRBASEURL`       | `mcsd.admin.<key>.fhirbaseurl`       | Map of root directories (mCSD Admin Directory FHIR base URLs) to synchronize from.                                                                                                                                                                                                        |
| `KNPT_MCSD_ADMINEXCLUDE`                  | `mcsd.adminexclude`                  | (Optional) List of FHIR base URLs to exclude from being registered as administration directories. Useful to prevent self-referencing loops when the query directory is discovered as an Endpoint. Multiple values can be specified as a comma-separated list.                             |
| `KNPT_MCSD_DIRECTORYRESOURCETYPES`        | `mcsd.directoryresourcetypes`        | (Optional) List of resource types to synchronize from discovered mCSD directories. Defaults to: `Organization`, `Endpoint`, `Location`, `HealthcareService`, `PractitionerRole`, `Practitioner`. Multiple values can be specified as a comma-separated list.                              |
| **Localization / NVI**                    |                                      |                                                                                                                                                                                                                                                                                           |
| `KNPT_NVI_BASEURL`                        | `nvi.baseurl`                        | Base URL of the NVI service.                                                                                                                                                                                                                                                              |
| `KNPT_NVI_AUDIENCE`                       | `nvi.audience`                       | Name of the NVI service, used for creating BSN transport tokens.<br/>Defaults to `nvi`.                                                                                                                                                                                                   |
| **Consent / Mitz**                        |                                      |                                                                                                                                                                                                                                                                                           |
| `KNPT_MITZ_MITZBASE`                      | `mitz.mitzbase`                      | Base URL of the MITZ endpoint                                                                                                                                                                                                                                                             |
| `KNPT_MITZ_NOTIFYENDPOINT`                | `mitz.notifyendpoint`                | Endpoint that will be used in `Subscription.channel.endpoint` when subscribing to Mitz (unless one is provided in the Subscription request to the knooppunt)                                                                                                                              |
| `KNPT_MITZ_GATEWAYSYSTEM`                 | `mitz.gatewaysystem`                 | gateway system OID to be used in a MITZ subscription (your gateway system OID)                                                                                                                                                                                                            |
| `KNPT_MITZ_SOURCESYSTEM`                  | `mitz.sourcesystem`                  | source system OID to be used in a MITZ subscription (your source system OID)                                                                                                                                                                                                              |
| `KNPT_MITZ_TLSCERTFILE`                   | `mitz.tlscertfile`                   | Path to client certificate (.p12/.pfx or .pem)                                                                                                                                                                                                                                            |
| `KNPT_MITZ_TLSKEYFILE`                    | `mitz.tlskeyfile`                    | Path to private key (only for .pem certs)                                                                                                                                                                                                                                                 |
| `KNPT_MITZ_TLSKEYPASSWORD`                | `mitz.tlskeypassword`                | Password for .p12/.pfx                                                                                                                                                                                                                                                                    |
| `KNPT_MITZ_TLSCAFILE`                     | `mitz.tlscafile`                     | Path to server certificate                                                                                                                                                                                                                                                                |
| **Authentication**                        |                                      |                                                                                                                                                                                                                                                                                           |
| `KNPT_AUTHN_CLIENTS_<index>_ID`           | `authn.clients.<index>.id`           | `client_id` for this OIDC/OAuth2 client.                                                                                                                                                                                                                                                  |
| `KNPT_AUTHN_CLIENTS_<index>_SECRET`       | `authn.clients.<index>.secret`       | `client_secret` for this OIDC/OAuth2 client.                                                                                                                                                                                                                                              |
| `KNPT_AUTHN_CLIENTS_<index>_REDIRECTURLS` | `authn.clients.<index>.redirecturls` | List of allowed redirect URLs for this OIDC/OAuth2 client. Multiple values can be specified as a comma-separated list.                                                                                                                                                                    |
| **Authorization**                         |                                      |                                                                                                                                                                                                                                                                                           |
| `KNPT_PIP_URL`                            | `authn.pip.url`                      | Address of the policy information point used for finding patient records and local consents                                                                                                                                                                                               |
| **Tracing / OpenTelemetry**               |                                      |                                                                                                                                                                                                                                                                                           |
| `KNPT_TRACING_OTLPENDPOINT`               | `tracing.otlpendpoint`               | OTLP collector address as `host:port`. Tracing is enabled when this is set.<br/>Example: `jaeger:4318`.                                                                                                                                                                                   |
| `KNPT_TRACING_INSECURE`                   | `tracing.insecure`                   | Use insecure (non-TLS) connection to OTLP endpoint.<br/>Defaults to `true`.                                                                                                                                                                                                               |
| `KNPT_TRACING_SERVICENAME`                | `tracing.servicename`                | Service name reported in traces.<br/>Defaults to `nuts-knooppunt`.                                                                                                                                                                                                                        |
